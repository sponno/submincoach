<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basketball Substitution Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <link href="output.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-0">
<div id="app" class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-lg">
    <h1 class="text-xl font-bold mb-2 text-gray-800" v-if="!gameStarted">SUB ME IN COACH</h1>
    <h1 class="text-sm font-bold mb-1 text-gray-800" v-else>SUB ME IN COACH</h1>

    <div v-if="!gameStarted">
        <h2 class="text-2xl font-semibold mb-2">My Players</h2>
        <div class="mb-4 flex space-x-2">
            <input v-model="newPlayerName" @keyup.enter="addPlayer" placeholder="Enter player name"
                   class="border border-gray-300 p-2 rounded-md flex-1"/>
            <button @click="addPlayer" class="bg-purple-500 hover:bg-green-600 text-white py-2 px-4 rounded-md">Add Player</button>
        </div>
        
        <div class="flex justify-between mb-4">
            <div class="w-1/2 mr-2">
                <label class="block font-semibold mb-2">Number of Periods</label>
                <select v-model="numberOfPeriods" class="border border-gray-300 p-2 rounded-md w-full">
                    <option v-for="n in [1, 2, 3, 4, 5]" :key="n" :value="n">{{ n }}</option>
                </select>
            </div>
            <div class="w-1/2 ml-2">
                <label class="block font-semibold mb-2">Period Duration</label>
                <select v-model="periodDuration" class="border border-gray-300 p-2 rounded-md w-full">
                    <option v-for="n in Array.from({ length: 45 }, (v, i) => i + 1)" :key="n" :value="n">{{ n }} mins</option>
                </select>
            </div>
        </div>

        <ul class="mb-4">
            <li v-for="player in allPlayers" :key="player.id" class="flex items-center w-full">
                <div class="flex items-center justify-between bg-gray-100 p-4 rounded-md mb-2 w-full mr-4">
                    <span>{{ player.name }}</span>
                    <label class="flex items-center">playing &nbsp;<input type="checkbox" v-model="player.present" class="w-4 h-4"></label>
                </div>
                <button @click="removePlayer(player)">&times;</button>
            </li>
        </ul>
        <button @click="startGame" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md">Start Game</button>
    </div>

    <div v-else>
        <div class="game-controls mb-6 flex items-center gap-x-6">
            <h2 class="text-2xl font-semibold">Period {{ currentPeriod }} - Time: {{ formatTime(gameTime) }}</h2>
            <button @click="toggleTimer" class="text-sm bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-3 rounded-md">
                {{ timerRunning ? 'Pause' : 'Resume' }}
            </button>
            <button @click="returnToManage" class="text-sm bg-gray-500 hover:bg-gray-600 text-white py-2 px-3 rounded-md">Manage Players</button>
        </div>

        <h3 class="text-xl font-semibold mb-2">On Court <span> - {{ onCourtPlayers.length }}</span></h3>
        <transition-group name="fade" tag="ul" class="mb-4 space-y-2">
            <li v-for="player in onCourtPlayers" :key="player.id" class="p-4 rounded-md flex flex-col">
                <div class="flex items-center justify-between mb-1">
                    <span>{{ player.name }} - played: {{ formatTime(player.timePlayed) }}</span>
                    <button @click="substituteOut(player)" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded-md">Sub Out</button>
                </div>
                <div class="w-full bg-green-200 rounded-full h-4 overflow-hidden">
                    <div class="bg-green-500 h-full" :style="{ width: `${(player.timePlayedThisPeriod / (periodDuration * 60)) * 100}%` }"></div>
                </div>
                <div class="w-full bg-green-100 rounded-full h-0.5 mt-1 overflow-hidden">
                    <div class="bg-green-700 h-full" :style="{ width: `${(player.timePlayed / (periodDuration * 60 * numberOfPeriods)) * 100}%` }"></div>
                </div>
            </li>
        </transition-group>

        <h3 class="text-xl font-semibold mb-2">On Bench</h3>
        <transition-group name="fade" tag="ul" class="space-y-2">
            <li v-for="player in benchPlayers" :key="player.id" class="p-4 rounded-md flex flex-col">
                <div class="flex items-center justify-between mb-1">
                    <span>{{ player.name }} - played: {{ formatTime(player.timePlayed) }}</span>
                    <button @click="substituteIn(player)" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded-md">Sub In</button>
                </div>
                <div class="w-full bg-red-200 rounded-full h-4 overflow-hidden">
                    <div class="bg-red-500 h-full" :style="{ width: `${(player.timePlayedThisPeriod / (periodDuration * 60)) * 100}%` }"></div>
                </div>
                <div class="w-full bg-red-100 rounded-full h-0.5 mt-1 overflow-hidden">
                    <div class="bg-red-700 h-full" :style="{ width: `${(player.timePlayed / (periodDuration * 60 * numberOfPeriods)) * 100}%` }"></div>
                </div>
            </li>
        </transition-group>
    </div>
</div>

<script>
    const {createApp, ref, computed, onMounted, onUnmounted, watch} = Vue

    createApp({
        setup() {
            const allPlayers = ref([])
            const newPlayerName = ref('')
            const gameStarted = ref(false)
            const gameTime = ref(0)
            const timerRunning = ref(false)
            const currentPeriod = ref(1)
            const numberOfPeriods = ref(2)  // Default to 2 periods
            const periodDuration = ref(10)  // Default to 10 minutes
            let timerInterval
            
            const loadPlayers = () => {
                const storedPlayers = localStorage.getItem('basketballPlayers')
                if (storedPlayers) {
                    allPlayers.value = JSON.parse(storedPlayers).map(p => ({
                        ...p, 
                        present: false, 
                        onCourt: false, 
                        timePlayed: 0,
                        timePlayedThisPeriod: 0
                    }))
                }
            }

            const savePlayers = () => {
                localStorage.setItem('basketballPlayers', JSON.stringify(allPlayers.value.map(({id, name}) => ({id, name}))))
            }

            const addPlayer = () => {
                if (newPlayerName.value.trim()) {
                    allPlayers.value.push({
                        id: Date.now(),
                        name: newPlayerName.value.trim(),
                        present: true,
                        onCourt: false,
                        timePlayed: 0,
                        timePlayedThisPeriod: 0
                    })
                    newPlayerName.value = ''
                    savePlayers()
                }
            }

            const removePlayer = (player) => {
                const index = allPlayers.value.findIndex(p => p.id === player.id)
                allPlayers.value.splice(index, 1)
                savePlayers()
            }

            const presentPlayers = computed(() => allPlayers.value.filter(p => p.present))
            const onCourtPlayers = computed(() => presentPlayers.value.filter(p => p.onCourt))
            const benchPlayers = computed(() => presentPlayers.value.filter(p => !p.onCourt))

            const startGame = () => {
                gameStarted.value = true
                if (!timerRunning.value) {
                    startTimer()
                }
            }

            const startTimer = () => {
                timerRunning.value = true
                timerInterval = setInterval(() => {
                    gameTime.value++
                    onCourtPlayers.value.forEach(p => {
                        p.timePlayed++
                        p.timePlayedThisPeriod++
                    })

                    // Stop the timer when the period duration is reached
                    if (gameTime.value >= periodDuration.value * 60) {
                        stopTimer()
                        nextPeriod()
                    }
                }, 1000)
            }

            const stopTimer = () => {
                clearInterval(timerInterval)
                timerRunning.value = false
            }

            const toggleTimer = () => {
                if (timerRunning.value) {
                    stopTimer()
                } else {
                    startTimer()
                }
            }

            const substituteOut = (player) => {
                player.onCourt = false
                const index = presentPlayers.value.findIndex(p => p.id === player.id)
                presentPlayers.value.splice(index, 1)
                presentPlayers.value.push(player)
            }

            const substituteIn = (player) => {
                player.onCourt = true
                const index = presentPlayers.value.findIndex(p => p.id === player.id)
                presentPlayers.value.splice(index, 1)
                presentPlayers.value.push(player)
            }

            const resetGame = () => {
                gameTime.value = 0
                currentPeriod.value = 1
                allPlayers.value.forEach(p => {
                    p.onCourt = false
                    p.timePlayed = 0
                    p.timePlayedThisPeriod = 0
                })
                if (timerRunning.value) {
                    stopTimer()
                }
            }

            const returnToManage = () => {
                gameStarted.value = false
                // We don't reset the game here anymore
            }

            const nextPeriod = () => {
                if (currentPeriod.value < numberOfPeriods.value) {
                    gameTime.value = 0 // Reset timer to zero for the next period
                    currentPeriod.value++
                    // Reset timePlayedThisPeriod for all players
                    allPlayers.value.forEach(p => p.timePlayedThisPeriod = 0)
                } else {
                    // End of the game
                    alert("Game Over!")
                    resetGame()
                }
            }

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60)
                const secs = seconds % 60
                return `${mins}:${secs.toString().padStart(2, '0')}`
            }

            const loadGameState = () => {
                const storedGameState = localStorage.getItem('gameState')
                if (storedGameState) {
                    const state = JSON.parse(storedGameState)
                    gameStarted.value = state.gameStarted
                    gameTime.value = state.gameTime
                    currentPeriod.value = state.currentPeriod
                    timerRunning.value = state.timerRunning
                    allPlayers.value = state.players
                }
            }

            const saveGameState = () => {
                const state = {
                    gameStarted: gameStarted.value,
                    gameTime: gameTime.value,
                    currentPeriod: currentPeriod.value,
                    timerRunning: timerRunning.value,
                    players: allPlayers.value
                }
                localStorage.setItem('gameState', JSON.stringify(state))
            }

            const loadGameSettings = () => {
                const storedNumberOfPeriods = localStorage.getItem('numberOfPeriods')
                const storedPeriodDuration = localStorage.getItem('periodDuration')
                if (storedNumberOfPeriods) {
                    numberOfPeriods.value = parseInt(storedNumberOfPeriods)
                }
                if (storedPeriodDuration) {
                    periodDuration.value = parseInt(storedPeriodDuration)
                }
            }

            const saveGameSettings = () => {
                localStorage.setItem('numberOfPeriods', numberOfPeriods.value)
                localStorage.setItem('periodDuration', periodDuration.value)
            }

            onMounted(() => {
                loadPlayers()
                loadGameState()
                loadGameSettings()
                if (gameStarted.value && timerRunning.value) {
                    startTimer()
                }
            })

            onUnmounted(() => {
                clearInterval(timerInterval)
            })

            watch([gameStarted, gameTime, currentPeriod, timerRunning, allPlayers], saveGameState, {deep: true})
            watch([numberOfPeriods, periodDuration], saveGameSettings)

            return {
                allPlayers,
                newPlayerName,
                removePlayer,
                gameStarted,
                gameTime,
                timerRunning,
                currentPeriod,
                numberOfPeriods,
                periodDuration,
                presentPlayers,
                onCourtPlayers,
                benchPlayers,
                addPlayer,
                startGame,
                toggleTimer,
                substituteOut,
                substituteIn,
                resetGame,
                returnToManage,
                nextPeriod,
                formatTime
            }
        }
    }).mount('#app')
</script>
</body>
</html>